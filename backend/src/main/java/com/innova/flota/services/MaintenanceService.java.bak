package com.innova.flota.services;

import com.innova.flota.model.MaintenanceTicket;
import com.innova.flota.model.QRCode;
import com.innova.flota.model.Vehicle;
import com.innova.flota.repositories.MaintenanceTicketRepository;
import com.innova.flota.repositories.QRCodeRepository;
import com.innova.flota.repositories.VehicleRepository;
import lombok.AllArgsConstructor;
import org.springframework.stereotype.Service;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ObjectNode;

import java.sql.Timestamp;
import java.time.Instant;
import java.util.Date;
import java.util.List;

@Service
@AllArgsConstructor
public class MaintenanceService {

    private final MaintenanceTicketRepository maintenanceTicketRepository;
    private final VehicleRepository vehicleRepository;
    private final QRCodeRepository qrCodeRepository;
    private final ObjectMapper objectMapper;

    public MaintenanceTicket scheduleMaintenance(Long qrCodeId, Long workshopId, String maintenanceDate) {
        // Ensure vehicle exists
        if (!qrCodeRepository.existsById(qrCodeId)) {
            throw new RuntimeException("QR not found for ID: " + qrCodeId);
        }

        QRCode qrCode = qrCodeRepository.findById(qrCodeId).get();
        String barcode = qrCode.getBarcodeText();
        JsonNode barcodeNode = objectMapper.valueToTree(barcode);

        MaintenanceTicket maintenanceTicket = MaintenanceTicket.builder()
            .vehicleID(barcodeNode.get("id_vehicle").asLong())
            .workshopId(workshopId)
            .status("PENDING")
            .fechaMantencion(Date.from(Instant.parse(maintenanceDate)))
            .createdAt(Timestamp.from(Instant.now()))
            .build();

        return maintenanceTicketRepository.save(maintenanceTicket);
    }

    public MaintenanceTicket completeMaintenance(Long maintenanceId, String notes, Integer finalMileage) {
        MaintenanceTicket log = maintenanceTicketRepository.findById(maintenanceId)
                .orElseThrow(() -> new RuntimeException("Maintenance Log not found"));

        log.setStatus("COMPLETED");
        if (notes != null) {
            log.setNotasExtra(notes);
        }

        // Update vehicle mileage if provided
        if (finalMileage != null) {
            Vehicle vehicle = vehicleRepository.findById(log.getVehicleID())
                    .orElseThrow(() -> new RuntimeException("Vehicle not found"));

            if (finalMileage >= vehicle.getKmRecorrido()) {
                vehicle.setKmRecorrido(finalMileage);
                vehicleRepository.save(vehicle);
            }
            log.setMillaje(finalMileage);
        }

        return maintenanceTicketRepository.save(log);
    }

    public List<MaintenanceTicket> getMaintenanceHistory(Long vehicleId) {
        // This assumes we might need a custom query in repository if not available,
        // but for now let's see if we can filter or if we need to add a method to repo.
        // Since I can't easily change repo interface without checking it first,
        // I'll assume for now we might need to fetch all or use an example matcher,
        // BUT standard JPA repos usually don't have findByVehicleID unless defined.
        // Let's check the repo content again or just add the method to the repo if
        // needed.
        // For this step, I will assume the repo needs the method.
        // Wait, I can't edit the repo in this same step safely if I'm not sure.
        // I'll leave this method commented or simple for now and fix repo in next step.
        return maintenanceTicketRepository.findAll().stream()
                .filter(log -> log.getVehicleID().equals(vehicleId))
                .toList();
    }
}
